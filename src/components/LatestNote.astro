---
import { fetchLatestNote, formatDate, getNevent } from '@/lib/utils';
import type { NostrEvent } from '@/lib/utils';
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardFooter,
} from '@/components/ui/card'
import Link from '@/components/Link.astro'
import { Button } from '@/components/ui/button'
import { Icon } from 'astro-icon/components'

const publicKey = '07907690ce3fec30fb2089eb5a61c147548c244ba85605e713d7991cd4e015f6';
let latestNote: NostrEvent | null = null;
let errorMessage: string | null = null;

try {
  latestNote = await fetchLatestNote(publicKey);
} catch (error) {
  errorMessage = 'Failed to fetch the latest note.';
}

const date = latestNote ? new Date(latestNote.created_at * 1000) : null;
const formattedDate = date ? formatDate(date) : 'No date';
  
  const eventId = latestNote ? latestNote.id : 'No event';
const nevent = getNevent(eventId);

console.log('Nevent:', nevent);
---

<div>
        {latestNote ? (
        <>
          <Card>
          <CardHeader>
            <CardTitle className="font-bold flex flex-wrap items-center -mb-4 -mt-3">
              <Icon name="nostr" class="size-16 -ml-5" /> Nostr note</CardTitle>
            
          </CardHeader>
          <CardContent>
            <p class="mb-2 text-sm">
              {errorMessage || (latestNote?.content ?? 'No notes available.')}
            </p>
          </CardContent>
          <CardFooter ><span class="text-xs text-muted-foreground mr-2">{formattedDate}</span> <Button variant="ghost">
<Link
        href=`https://zapper.nostrapps.org/zap?id=${nevent}&type=zap`
        external
      >&#x26A1; Zap</Link></Button> <Button variant="ghost">
<Link
        href=`https://nostr.band/${nevent}`
        external
      >Open&#10139;</Link></Button></CardFooter>
            
        </Card>
        </>
        ) : ( <p>No latest note available.</p>)}
      </div>