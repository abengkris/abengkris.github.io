---
export const prerender = false;
import type { NostrEvent } from "@/lib/utils";
import { getNevent, formatDateNostr } from "@/lib/utils";
import { Card, CardContent, CardHeader, CardTitle, CardFooter } from "@/components/ui/card";
import Link from "@/components/Link.astro";
import { Button } from "@/components/ui/button";
import { Icon } from "astro-icon/components";

const baseUrl = "https://abeng.xyz";

let latestNote: NostrEvent | null = null;
let errorMessage: string | null = null;
let formatDate: string | null = null;

try {
  const response = await fetch(`${baseUrl}/api/fetch-nostr-note`);
  if (response.ok) {
    const data = await response.json();
    latestNote = data.latestNote;
    formatDate = formatDateNostr(data.latestNote.created_at);
  } else {
    errorMessage = "Failed to fetch the latest note. API returned an error.";
  }
} catch (error) {
  errorMessage = "Failed to fetch the latest note. Please try again later.";
}
---

<div>
  {latestNote ? (
    <Card>
      <CardHeader>
        <CardTitle className="font-bold flex flex-wrap items-center -mb-4 -mt-3">
          <Icon name="nostr" class="size-16 -ml-5" /> Latest nostr note:
        </CardTitle>
      </CardHeader>
      <CardContent>
        <p class="mb-2 text-sm">
          {latestNote?.content ?? "No content available."}
        </p>
      </CardContent>
      <CardFooter>
        <span class="text-xs text-muted-foreground mr-2">{formatDate}</span>
        <Link
          href={`https://zapper.nostrapps.org/zap?id=${getNevent(latestNote.id)}&type=zap`}
          external
        >
          <Button variant="ghost">&#x26A1; Zap</Button>
        </Link>
        <Link href={`https://nostr.band/${getNevent(latestNote.id)}`} external>
          <Button variant="ghost">Open&#10139;</Button>
        </Link>
      </CardFooter>
    </Card>
  ) : (
    <p>{errorMessage || "No latest note available."}</p>
  )}
</div>